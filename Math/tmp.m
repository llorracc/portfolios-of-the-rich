ClearAll[EtRtp1ToTheAlpha];EtRtp1ToTheAlpha[QState_,KSharet_,RiskySharet_] := Block[{}, sttmp=st;PermInctmp=PermInc;QStatetmp=QState;EmpStatetmp=EmpState;KSharettmp=KSharet;RiskySharettmp=RiskySharet; If[KSharet>1 || KSharet<0 || RiskySharet>1 || RiskySharet<0,   (* then they've violated the portfolio constraints so punish them *)     1000000,   (* else they've chosen valid portfolio shares so calculate values *)   Sum[             (* over possible entrepreneurial rates of return       *)    Sum[            (* over possible future QStates                        *)      Sum[          (* over possible future stock return states            *)          Rtp1 = (R[[LoopOverRVals]]*RiskySharet*(1-KSharet)                 +If[QState>1,K[[LoopOverKVals]]*KSharet*Omega[KSharet],0]                 +Rcertain*((1-KSharet)(1-RiskySharet)));          Rtp1^(1-alpha)        *Rprob[[LoopOverRVals]]      ,{LoopOverRVals,NumOfRVals}]                                               (* End loop over RVals *)      *QStateProbtp1[QState,KSharet,LoopOverKVals,LoopOverQStates]    ,{LoopOverQStates,NumOfQStates}]                                             (* End loop over QStates  *)     *Kprob[[LoopOverKVals]]   ,{LoopOverKVals,Length[K]}] ] (* End If KSharet>1 *)]